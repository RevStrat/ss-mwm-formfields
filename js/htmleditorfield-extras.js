!function(e){e.entwine("ss",function(e){e("textarea.htmleditor").entwine({onadd:function(){var e=tinyMCE.get(this.attr("id"));e||this._super()},redraw:function(){var t=this,n=t.attr("id"),i=n+"--"+window.location.pathname.replace(/\W/g,""),s=t.data("config"),a=t.data("customConfig")||null,o=function(e,t){null===a&&(a={}),a[e]=t};t.data("tinymceContentCss")&&(o("old_content_css",ssTinyMceConfig[s].content_css),o("content_css",t.data("tinymceContentCss"))),t.hasClass("limited-with-media")&&this.checkIfPluginExistsInConfig("-ssbuttons",ssTinyMceConfig[s])&&!this.checkIfButtonExistsInLimitedConfig("ssmedia",ssTinyMceConfig[s])&&o("theme_advanced_buttons1",(a&&a.hasOwnProperty("theme_advanced_buttons1")?a.theme_advanced_buttons1:ssTinyMceConfig[s].theme_advanced_buttons1)+",ssmedia,ssflash"),t.hasClass("limited-with-links")&&this.checkIfPluginExistsInConfig("-ssbuttons",ssTinyMceConfig[s])&&!this.checkIfButtonExistsInLimitedConfig("sslink",ssTinyMceConfig[s])&&o("theme_advanced_buttons1",(a&&a.hasOwnProperty("theme_advanced_buttons1")?a.theme_advanced_buttons1:ssTinyMceConfig[s].theme_advanced_buttons1)+",sslink,unlink"),t.hasClass("limited-with-source")&&(this.checkIfButtonExistsInExtendedConfig("code",ssTinyMceConfig[s])&&!this.checkIfButtonExistsInLimitedConfig("code",ssTinyMceConfig[s])&&o("theme_advanced_buttons1",(a&&a.hasOwnProperty("theme_advanced_buttons1")?a.theme_advanced_buttons1:ssTinyMceConfig[s].theme_advanced_buttons1)+",code"),this.checkIfButtonExistsInExtendedConfig("fullscreen",ssTinyMceConfig[s])&&!this.checkIfButtonExistsInLimitedConfig("fullscreen",ssTinyMceConfig[s])&&o("theme_advanced_buttons1",(a&&a.hasOwnProperty("theme_advanced_buttons1")?a.theme_advanced_buttons1:ssTinyMceConfig[s].theme_advanced_buttons1)+",fullscreen")),t.hasClass("limited")&&this.checkIfButtonExistsInExtendedConfig("removeformat",ssTinyMceConfig[s])&&!this.checkIfButtonExistsInLimitedConfig("removeformat",ssTinyMceConfig[s])&&o("theme_advanced_buttons1",(a&&a.hasOwnProperty("theme_advanced_buttons1")?a.theme_advanced_buttons1:ssTinyMceConfig[s].theme_advanced_buttons1)+",removeformat"),t.data("tinymceClasses")&&(ssTinyMceConfig[s].hasOwnProperty("body_class")?o("body_class",ssTinyMceConfig[s].body_class+" "+t.data("tinymceClasses")):o("body_class",t.data("tinymceClasses")));var r=ssTinyMceConfig[s].hasOwnProperty("setup")&&a&&!a.hasOwnProperty("extrasHaveBeenSetup")?ssTinyMceConfig[s].setup:null;return o("extrasHaveBeenSetup",!0),o("extrasHaveBeenSetup",function(n){var i=0,a=0,o=0,d=e("#"+n.editorId),c="";if(d.attr("maxlength")){var l=d.attr("maxlength"),h=d.data("tinymceMaxlengthIndicator");h&&(c=ss.i18n._t("HTMLEditorField.THERE_ARE","There are")+" "+l+" "+ss.i18n._t("HTMLEditorField.CHARACTERS_LEFT","characters left"),h&&("string"==typeof h||h instanceof String)&&(h=e(h)),h.length&&(h.text(c),0>=l?h.addClass("error"):h.removeClass("error"))),n.onKeyUp.add(function(e,n){a=t.getTextCountFromEditor(e),i=l-a,0>i&&(i=0),h.length&&(c=ss.i18n._t("HTMLEditorField.THERE_ARE","There are")+" "+i+" "+ss.i18n._t("HTMLEditorField.CHARACTERS_LEFT","characters left"),h.length?(h.text(c),0>=i?h.addClass("error"):h.removeClass("error")):0>=i||o!=a&&statusMessage(c)),setTimeout(function(){o=a},0)}),n.onChange.add(function(e,n){a=t.getTextCountFromEditor(e),i=l-a,0>i&&(i=0),h.length&&(c=ss.i18n._t("HTMLEditorField.THERE_ARE","There are")+" "+i+" "+ss.i18n._t("HTMLEditorField.CHARACTERS_LEFT","characters left"),h.length?(h.text(c),0>=i?h.addClass("error"):h.removeClass("error")):0>=i||o!=a&&statusMessage(c)),setTimeout(function(){o=a},0)}),n.onKeyDown.add(function(e,n){i||(a=t.getTextCountFromEditor(e),i=l-a),0>=i&&8!=n.keyCode&&46!=n.keyCode&&(tinymce.dom.Event.cancel(n),errorMessage(ss.i18n.sprintf(ss.i18n._t("HTMLEditorField.MAX_CHARACTERS","This field can only contain %s characters"),l)))})}r&&r(n);var u=ssTinyMceConfig[s].hasOwnProperty("editor_selector")?ssTinyMceConfig[s].editor_selector:"";n.onPostRender.add(function(n){var i=e("#"+n.editorId).siblings("#"+n.editorContainer);setTimeout(function(){n.container?e(n.container).addClass(t.attr("class").replace(u,"")):i.length&&i.addClass(t.attr("class").replace(u,""))},10)})}),null!==a?(ssTinyMceConfig[i]=e.extend({},ssTinyMceConfig[s],a),ssTinyMceConfig[i].inheritedFrom=s,t.data("customConfig",ssTinyMceConfig[i]),t.data("config",i),this._super()):this._super()},getTextCountFromEditor:function(e){e||(e=this.getEditor());var t=e.getContent().replace(/<[^>]*>/g,"").replace(/\s+/g," ");return t=t.replace(/^\s\s*/,"").replace(/\s\s*$/,""),t?t.length:0},checkIfPluginExistsInConfig:function(e,t){return t.hasOwnProperty("plugins")&&-1!==t.plugins.indexOf(e)},checkIfButtonExistsInExtendedConfig:function(e,t){return t.hasOwnProperty("theme_advanced_buttons2")&&-1!==t.theme_advanced_buttons2.indexOf(e)||t.hasOwnProperty("theme_advanced_buttons3")&&-1!==t.theme_advanced_buttons3.indexOf(e)},checkIfButtonExistsInLimitedConfig:function(e,t){return t.hasOwnProperty("theme_advanced_buttons1")&&-1!==t.theme_advanced_buttons1.indexOf(e)}}),e("form.htmleditorfield-linkform").entwine({getEditorField:function(){return e("#"+this.getEditor().getInstance().editorId)},googleLinkTracking:function(){var e=this.getEditorField();return e.length&&e.hasClass("google-link-tracking")},emailFriendly:function(){var e=this.getEditorField();return e.length&&e.hasClass("email-friendly")},redraw:function(){this._super();var e=this.find(":input[name=LinkType]:checked").val(),t=this.emailFriendly();this.googleLinkTracking()&&this.find(".google-analytics-tracking").show().find(".field").show(),t||"internal"!==e&&"external"!==e||!this.find('.field[id$="TargetModal"]').length||this.find('.field[id$="TargetModal"]').show(),"phone"===e&&(this.find(".field#TargetBlank").hide(),this.find(".field#phone").show())},getLinkAttributes:function(t){var n=this._super(),i=this.find(":input[name=utm_source]");if("phone"===this.find(":input[name=LinkType]:checked").val()&&n.hasOwnProperty("href")&&(n.href="tel:"+this.find(":input[name=phone]").val()),this.find(":input[name=TargetModal]").is(":checked")&&(n["data-toggle"]="modal"),n.hasOwnProperty("href")&&0!==n.href.indexOf("mailto:")&&0!==n.href.indexOf("tel:")&&i.length&&i.val()){var s=this.find(":input[name=utm_medium]").val(),a=this.find(":input[name=utm_term]").val(),o=this.find(":input[name=utm_content]").val(),r=this.find(":input[name=utm_campaign]").val(),d={utm_source:encodeURIComponent(i.val())};s?d.utm_medium=s:d.utm_medium=encodeURIComponent("none"),a&&(d.utm_term=encodeURIComponent(a)),o&&(d.utm_content=encodeURIComponent(o)),r&&(d.utm_campaign=encodeURIComponent(r)),-1!=n.href.indexOf("?")?n.href+="&amp;"+e.param(d).replace("&","&amp;"):n.href+="?"+e.param(d)}return n},getCurrentLink:function(){var t=this._super(),n=this.googleLinkTracking();if(t&&t.hasOwnProperty("LinkType")&&"external"==t.LinkType&&t.hasOwnProperty("external")&&t.external.match(/^tel:(.*)$/)&&(t.LinkType="phone",t.phone=RegExp.$1,delete t.external,delete t.TargetBlank),null!==t&&!n)return t;var i=this.getSelection(),s=null;if(i.length&&(s=i.is("a")?i:i=i.parents("a:first")),s&&s.length&&this.modifySelection(function(e){e.selectNode(s[0])}),s.attr("href")||(s=null),s&&s.hasData("toggle")&&"modal"==s.data("toggle")&&(t.TargetModal=!0),n)if(null!==t){var a=s.attr("href").replace("&amp;","&"),o=-1!=a.indexOf("?")?a.substring(a.indexOf("?")+1,a.length):"";if(o){var r,d=this.deparam(o);d&&!e.isEmptyObject(d)&&e.each(d,function(e,n){0===e.indexOf("utm_")&&(r=e+"="+n,t[e]=decodeURIComponent(n),a=a.replace(r,"").replace(/[\?|&]+$/,""))}),a.match(/^\[sitetree_link(?:\s*|%20|,)?id=([0-9]+)\]?(#.*)?$/i)?(t.LinkType="internal",t.internal=RegExp.$1,t.Anchor=RegExp.$2?RegExp.$2.substr(1):"",t.hasOwnProperty("external")&&delete t.external):t.external=a}}else{var c=this.getEditorField(),l=c.data("utmSource"),h=c.data("utmMedium"),u=c.data("utmTerm"),f=c.data("utmContent"),m=c.data("utmCampaign");l&&(t.utm_source=0===l.indexOf("#")&&e(l).length?e(l).is(":input")?e(l).val():e(l).text():l),h&&(t.utm_medium=0===h.indexOf("#")&&e(h).length?e(h).is(":input")?e(h).val():e(h).text():h),u&&(t.utm_term=0===u.indexOf("#")&&e(u).length?e(u).is(":input")?e(u).val():e(u).text():u),f&&(t.utm_content=0===f.indexOf("#")&&e(f).length?e(f).is(":input")?e(f).val():e(f).text():f),m&&(t.utm_campaign=0===m.indexOf("#")&&e(m).length?e(m).is(":input")?e(m).val():e(m).text():m)}return t},deparam:function(e){e=e.substring(e.indexOf("?")+1).split("&");var t,n,i={},s=decodeURIComponent;for(n=e.length;n>0;)t=e[--n].split("="),i[s(t[0])]=s(t[1]);return i}})})}(jQuery);